*&---------------------------------------------------------------------*
*& Report  ZR_FI_EXPORT_SUBSIDY_TEVA_UP
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  ZR_FI_EXPORT_SUBSIDY_TEVA_UP.


INCLUDE ZR_FI_EXPORT_DD.
INCLUDE ZR_FI_EXPORT_SS.


AT SELECTION-SCREEN ON VALUE-REQUEST FOR M_FNAME.

*  DATA: LT_FTAB TYPE FILETABLE,
*        LS_FTAB TYPE FILE_TABLE,
*        LS_FILE TYPE LINE OF FILETABLE.
DATA: LT_FILE TYPE FILETABLE,
      LS_FILE TYPE LINE OF FILETABLE.

  CALL METHOD CL_GUI_FRONTEND_SERVICES=>FILE_OPEN_DIALOG
*  EXPORTING
*    WINDOW_TITLE            =
*    DEFAULT_EXTENSION       =
*    DEFAULT_FILENAME        =
*    FILE_FILTER             =
*    WITH_ENCODING           =
*    INITIAL_DIRECTORY       =
*    MULTISELECTION          =
  CHANGING
    FILE_TABLE              = LT_FILE
    RC                      = G_RC
*    USER_ACTION             =
*    FILE_ENCODING           =
  EXCEPTIONS
    FILE_OPEN_DIALOG_FAILED = 1
    CNTL_ERROR              = 2
    ERROR_NO_GUI            = 3
    NOT_SUPPORTED_BY_GUI    = 4
    OTHERS                  = 5
        .
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  READ TABLE LT_FILE INTO LS_FILE INDEX 1.
*  G_FILE  = LS_FTAB-FILENAME.
  M_FNAME = LS_FILE-FILENAME.

START-OF-SELECTION.

  PERFORM UPLOAD_EXCEL.
  DATA L TYPE n .
  data: error TYPE string.
LOOP AT GT_FINAL INTO GS_FINAL.
*l = l + 1.
*IF GS_FINAL-MATNR = '' OR GS_FINAL-WERKS = '' OR GS_FINAL-GJAHR = '' OR GS_FINAL-ZMONTH = '' OR GS_FINAL-ZISP = '' .
*  CONCATENATE 'Please Fill Missing Data On The File, ' 'LINE '  l INTO error SEPARATED BY space .
*  MESSAGE ERROR TYPE 'E'.
*  ELSE.

WA_ZTEVA-VBELN  = GS_FINAL-VBELN.
WA_ZTEVA-POSNR  = GS_FINAL-POSNR.
WA_ZTEVA-BILLING_DATE  = GS_FINAL-BILLING_DATE.
WA_ZTEVA-BILLING_QTY = GS_FINAL-BILLING_QTY.
WA_ZTEVA-EXCHANGE_RATE  = GS_FINAL-EXCHANGE_RATE.
WA_ZTEVA-NET_VALUE  = GS_FINAL-NET_VALUE.
WA_ZTEVA-MATERIAL  = GS_FINAL-MATERIAL.
WA_ZTEVA-DESCRIPTION  = GS_FINAL-DESCRIPTION.
WA_ZTEVA-CCODE = GS_FINAL-CCODE.
WA_ZTEVA-CURRENCY = GS_FINAL-CURRENCY.

WA_ZTEVA-CREATEDON = SY-DATUM.
WA_ZTEVA-CREATEDBY  = SY-UNAME.




MODIFY  ZTEVA FROM WA_ZTEVA.
*  ENDIF.
  CLEAR : GS_FINAL , WA_ZTEVA.
ENDLOOP.

      DATA MSG TYPE STRING.
      DESCRIBE TABLE GT_FINAL LINES L.
      CLEAR MSG.
      CONCATENATE L 'line(s) updated' INTO MSG SEPARATED BY SPACE.
      MESSAGE MSG TYPE 'I'.

  FORM UPLOAD_EXCEL .

  FILENAME = M_FNAME.
  DATA: I_TAB_DATA TYPE TRUXS_T_TEXT_DATA.
  CALL FUNCTION 'TEXT_CONVERT_XLS_TO_SAP'
    EXPORTING
      I_FIELD_SEPERATOR    = '#'
      I_LINE_HEADER        = 'X'
      I_TAB_RAW_DATA       = I_TAB_DATA
      I_FILENAME           = FILENAME
    TABLES
      I_TAB_CONVERTED_DATA = GT_FINAL
    EXCEPTIONS
      CONVERSION_FAILED    = 1
      OTHERS               = 2.
  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.                    " UPLOAD_EXCEL


FORM DOWNLOAD_ERRORFILE .

  DATA: L_EFILE TYPE RLGRAP-FILENAME,
        L_EXT(5).
  DATA LT_CONV TYPE TRUXS_T_TEXT_DATA.
  DATA L_STR   TYPE STRING.

  SPLIT M_FNAME AT '.' INTO L_EFILE L_EXT.
  CONCATENATE L_EFILE '_ERR' INTO L_EFILE.
*      L_EXT = 'TXT'.
  CONCATENATE L_EFILE L_EXT INTO L_EFILE SEPARATED BY '.'.

  L_STR = L_EFILE.

  CALL FUNCTION 'SAP_CONVERT_TO_XLS_FORMAT'
    EXPORTING
     I_FIELD_SEPERATOR          = 'X'
*         I_LINE_HEADER              =
      I_FILENAME                 = L_EFILE
*         I_APPL_KEEP                = ' '
    TABLES
      I_TAB_SAP_DATA             = GT_ERR
   CHANGING
     I_TAB_CONVERTED_DATA       = LT_CONV
   EXCEPTIONS
     CONVERSION_FAILED          = 1
     OTHERS                     = 2
            .
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.
ENDFORM.                    " DOWNLOAD_ERRORFILE
